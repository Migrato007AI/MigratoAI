<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Step 1 - Credentials</title>
  <style>
    /* Your full style copied exactly as given */
    *, *::before, *::after {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f7f9fc;
      display: flex;
      justify-content: center;
      padding: 40px 20px;
      color: #2c3e50;
      font-size: 1.2rem;
    }
    .container {
      width: 100%;
      max-width: 900px;
      background: #fff;
      padding: 40px 40px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }
    h2 {
      margin-top: 0;
      margin-bottom: 40px;
      text-align: center;
      font-weight: 700;
      font-size: 2.4rem;
      color: #2c3e50;
    }
    h3 {
      font-weight: 700;
      font-size: 1.6rem;
      color: #005ea1;
      margin-bottom: 20px;
      border-bottom: 2px solid #0078d7;
      padding-bottom: 6px;
    }
    form {
      width: 100%;
    }
    .flex-row {
      display: flex;
      gap: 40px;
      margin-bottom: 40px;
      flex-wrap: wrap;
    }
    .flex-col {
      flex: 1;
      min-width: 280px;
    }
    label {
      display: block;
      font-weight: 600;
      color: #005ea1;
      margin-bottom: 8px;
      font-size: 1.2rem;
    }
    select, input[type="text"], input[type="password"] {
      width: 100%;
      padding: 12px 16px;
      font-size: 1.1rem;
      border: 1.5px solid #ccc;
      border-radius: 8px;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin-bottom: 24px;
      box-sizing: border-box;
    }
    select:focus, input[type="text"]:focus, input[type="password"]:focus {
      border-color: #005aab;
      box-shadow: 0 0 8px rgba(0, 90, 171, 0.4);
      outline: none;
    }
    .full-width {
      max-width: 400px;
      margin: 0 auto 40px auto;
    }
    button {
      display: block;
      margin: 0 auto;
      background-color: #0078d7;
      color: white;
      border: none;
      padding: 16px 48px;
      font-size: 1.4rem;
      font-weight: 600;
      border-radius: 50px;
      cursor: pointer;
      box-shadow: 0 6px 20px rgba(0,120,215,0.5);
      transition: background-color 0.3s ease, box-shadow 0.3s ease;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      min-width: 220px;
    }
    button:hover {
      background-color: #005ea1;
      box-shadow: 0 8px 26px rgba(0,94,161,0.7);
    }
    @media (max-width: 700px) {
      .flex-row {
        flex-direction: column;
        gap: 30px;
      }
      .full-width {
        max-width: 100%;
        margin-bottom: 30px;
      }
      button {
        width: 100%;
        min-width: auto;
      }
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Step 1: Enter Credentials &amp; CR Number</h2>
    <form method="post" action="/step2_synapse">
      <input type="hidden" name="SYNAPSE_TOKEN" value="{{ SYNAPSE_TOKEN }}">
      <input type="hidden" name="WORKSPACE_TOKEN" value="{{ WORKSPACE_TOKEN }}">
      <div class="flex-row">
        <!-- Source Synapse -->
        <div class="flex-col">
          <h3>Source Synapse</h3>
          <label for="sourceTenantId">Tenant ID:</label>
          <select id="sourceTenantId" name="sourceTenantId" required>
            <option value="" disabled selected>Select Tenant ID</option>
          </select>

          <label for="sourceSubscriptionName">Subscription Name:</label>
          <select id="sourceSubscriptionName" name="sourceSubscriptionName" required disabled>
            <option value="" disabled selected>Select Subscription</option>
          </select>

          <label for="sourceWorkspace">Workspace Name:</label>
          <select id="sourceWorkspace" name="sourceWorkspace" required disabled>
            <option value="" disabled selected>Select Workspace</option>
          </select>

          <div id="sourceRepoSection" class="hidden">
            <label for="sourceRepoName">Repo Name:</label>
            <input type="text" id="sourceRepoName" name="sourceRepoName" readonly />

            <label for="sourceFolderName">Folder Name:</label>
            <input type="text" id="sourceFolderName" name="sourceFolderName" readonly />

            <label for="sourceBranch">Branch:</label>
            <select id="sourceBranch" name="sourceBranch" required>
              <option value="feature">feature</option>
              <option value="features">features</option>
              <option value="demo_migration">demo_migration</option>
              <option value="working" selected>working</option>
            </select>

            <label for="sourcePAT">PAT Token:</label>
            <input type="password" id="sourcePAT" name="sourcePAT" placeholder="Enter PAT Token" required />
          </div>
        </div>

        <!-- Destination Synapse -->
        <div class="flex-col">
          <h3>Destination Synapse</h3>
          <label for="destTenantId">Tenant ID:</label>
          <select id="destTenantId" name="destTenantId" required>
            <option value="" disabled selected>Select Tenant ID</option>
          </select>

          <label for="destSubscriptionName">Subscription Name:</label>
          <select id="destSubscriptionName" name="destSubscriptionName" required disabled>
            <option value="" disabled selected>Select Subscription</option>
          </select>

          <label for="destWorkspace">Workspace Name:</label>
          <select id="destWorkspace" name="destWorkspace" required disabled>
            <option value="" disabled selected>Select Workspace</option>
          </select>

          <div id="destRepoSection" class="hidden">
            <label for="destRepoName">Repo Name:</label>
            <input type="text" id="destRepoName" name="destRepoName" readonly />

            <label for="destFolderName">Folder Name:</label>
            <input type="text" id="destFolderName" name="destFolderName" readonly />

            <label for="destBranch">Branch:</label>
            <select id="destBranch" name="destBranch" required>
              <option value="feature">feature</option>
              <option value="features">features</option>
              <option value="demo_migration">demo_migration</option>
              <option value="working" selected>working</option>
            </select>

            <label for="destPAT">PAT Token:</label>
            <input type="password" id="destPAT" name="destPAT" placeholder="Enter PAT Token" required />
          </div>
        </div>
      </div>

      <div class="full-width">
        <h3>Change Request Number</h3>
        <input type="text" name="crNumber" required placeholder="Enter CR Number" />
      </div>

      <button type="submit">Next: Fetch Objects</button>
    </form>
  </div>

  <script>
    // subscriptionData must be injected as JSON from backend, example:
    // const subscriptionData = {{ subscription_data | tojson | safe }};
    // For testing locally, you can define subscriptionData here as dummy data.

    const subscriptionData = {{ subscription_data | safe }};

    // Helper: get unique tenants
    function getUniqueTenants(data) {
      const tenants = new Set();
      data.forEach(item => tenants.add(item.tenant_id));
      return Array.from(tenants);
    }

    // Populate tenant select with strings
    function populateTenantSelect(selectElem, tenants, placeholder) {
      selectElem.innerHTML = '';
      const defaultOption = document.createElement('option');
      defaultOption.value = '';
      defaultOption.disabled = true;
      defaultOption.selected = true;
      defaultOption.textContent = placeholder;
      selectElem.appendChild(defaultOption);

      tenants.forEach(tenantId => {
        const option = document.createElement('option');
        option.value = tenantId;
        option.textContent = tenantId;
        selectElem.appendChild(option);
      });

      selectElem.disabled = tenants.length === 0;
    }

    // Populate select for subscriptions and workspaces with objects {value,label}
    function populateSelect(selectElem, options, placeholder) {
      selectElem.innerHTML = '';
      const defaultOption = document.createElement('option');
      defaultOption.value = '';
      defaultOption.disabled = true;
      defaultOption.selected = true;
      defaultOption.textContent = placeholder;
      selectElem.appendChild(defaultOption);
      options.forEach(opt => {
        const option = document.createElement('option');
        option.value = opt.value !== undefined ? opt.value : opt;
        option.textContent = opt.label !== undefined ? opt.label : opt;
        selectElem.appendChild(option);
      });
      selectElem.disabled = options.length === 0;
    }

    // Filter subscriptions by tenant ID
    function getSubscriptionsByTenant(data, tenantId) {
      return data.filter(item => item.tenant_id === tenantId);
    }

    // Get workspaces by subscription ID
    function getWorkspacesBySubscription(data, subscriptionId) {
      const sub = data.find(item => item.subscription_id === subscriptionId);
      return sub ? sub.workspace_list : [];
    }

    // Show/hide repo section based on flag, populate repo/folder names
    function updateRepoSection(prefix, workspaceObj) {
      const repoSection = document.getElementById(prefix + 'RepoSection');
      const repoNameInput = document.getElementById(prefix + 'RepoName');
      const folderNameInput = document.getElementById(prefix + 'FolderName');
      const branchSelect = document.getElementById(prefix + 'Branch');
      const patInput = document.getElementById(prefix + 'PAT');

      if (workspaceObj && workspaceObj.flag === 1) {
        repoSection.classList.remove('hidden');
        repoNameInput.value = workspaceObj.RepoName || '';
        folderNameInput.value = workspaceObj.FolderName || '';
        branchSelect.required = true;
        patInput.required = true;
        patInput.parentElement.style.display = 'block';
      } else {
        repoSection.classList.add('hidden');
        repoNameInput.value = '';
        folderNameInput.value = '';
        branchSelect.value = 'working';
        branchSelect.required = false;
        patInput.value = '';
        patInput.required = false;
        patInput.parentElement.style.display = 'none';
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      // Elements for source
      const sourceTenantSelect = document.getElementById('sourceTenantId');
      const sourceSubscriptionSelect = document.getElementById('sourceSubscriptionName');
      const sourceWorkspaceSelect = document.getElementById('sourceWorkspace');

      // Elements for destination
      const destTenantSelect = document.getElementById('destTenantId');
      const destSubscriptionSelect = document.getElementById('destSubscriptionName');
      const destWorkspaceSelect = document.getElementById('destWorkspace');

      // Populate tenants (strings)
      const tenants = getUniqueTenants(subscriptionData);
      populateTenantSelect(sourceTenantSelect, tenants, 'Select Tenant ID');
      populateTenantSelect(destTenantSelect, tenants, 'Select Tenant ID');

      // Tenant change updates subscription list and resets downstream selects
      sourceTenantSelect.addEventListener('change', () => {
        const tenantId = sourceTenantSelect.value;
        const subscriptions = getSubscriptionsByTenant(subscriptionData, tenantId)
          .map(s => ({ value: s.subscription_id, label: s.subscription_name }));
        populateSelect(sourceSubscriptionSelect, subscriptions, 'Select Subscription');
        sourceWorkspaceSelect.innerHTML = '<option value="" disabled selected>Select Workspace</option>';
        sourceWorkspaceSelect.disabled = true;
        updateRepoSection('source', null);
      });

      destTenantSelect.addEventListener('change', () => {
        const tenantId = destTenantSelect.value;
        const subscriptions = getSubscriptionsByTenant(subscriptionData, tenantId)
          .map(s => ({ value: s.subscription_id, label: s.subscription_name }));
        populateSelect(destSubscriptionSelect, subscriptions, 'Select Subscription');
        destWorkspaceSelect.innerHTML = '<option value="" disabled selected>Select Workspace</option>';
        destWorkspaceSelect.disabled = true;
        updateRepoSection('dest', null);
      });

      // Subscription change updates workspace list and resets repo section
      sourceSubscriptionSelect.addEventListener('change', () => {
        const subscriptionId = sourceSubscriptionSelect.value;
        const workspaces = getWorkspacesBySubscription(subscriptionData, subscriptionId);
        const workspaceOptions = workspaces.map(ws => ({
          value: ws.Synapse_workspace,
          label: ws.Synapse_workspace,
          fullObj: ws
        }));
        populateSelect(sourceWorkspaceSelect, workspaceOptions, 'Select Workspace');
        sourceWorkspaceSelect.disabled = workspaceOptions.length === 0;
        updateRepoSection('source', null);
      });

      destSubscriptionSelect.addEventListener('change', () => {
        const subscriptionId = destSubscriptionSelect.value;
        const workspaces = getWorkspacesBySubscription(subscriptionData, subscriptionId);
        const workspaceOptions = workspaces.map(ws => ({
          value: ws.Synapse_workspace,
          label: ws.Synapse_workspace,
          fullObj: ws
        }));
        populateSelect(destWorkspaceSelect, workspaceOptions, 'Select Workspace');
        destWorkspaceSelect.disabled = workspaceOptions.length === 0;
        updateRepoSection('dest', null);
      });

      // Workspace change updates repo section based on flag
      function handleWorkspaceChange(prefix, workspaceSelect) {
        const selectedWsName = workspaceSelect.value;
        const subscriptionSelect = document.getElementById(prefix + 'SubscriptionName');
        const subscriptionId = subscriptionSelect.value;
        if (!subscriptionId || !selectedWsName) {
          updateRepoSection(prefix, null);
          return;
        }
        const workspaces = getWorkspacesBySubscription(subscriptionData, subscriptionId);
        const workspaceObj = workspaces.find(ws => ws.Synapse_workspace === selectedWsName);
        updateRepoSection(prefix, workspaceObj);
      }

      sourceWorkspaceSelect.addEventListener('change', () => {
        handleWorkspaceChange('source', sourceWorkspaceSelect);
      });

      destWorkspaceSelect.addEventListener('change', () => {
        handleWorkspaceChange('dest', destWorkspaceSelect);
      });

      // Disable subscription and workspace selects initially
      sourceSubscriptionSelect.disabled = true;
      sourceWorkspaceSelect.disabled = true;
      destSubscriptionSelect.disabled = true;
      destWorkspaceSelect.disabled = true;

      // Hide PAT inputs initially
      document.getElementById('sourcePAT').parentElement.style.display = 'none';
      document.getElementById('destPAT').parentElement.style.display = 'none';
    });
  </script>
</body>
</html>