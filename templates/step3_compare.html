<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Step 3 - Compare Objects</title>

  <!-- diff2html CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css" />

  <!-- diff and diff2html JS -->
  <script src="https://cdn.jsdelivr.net/npm/diff@5.1.0/dist/diff.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html.min.js"></script>

  <style>
    *, *::before, *::after {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f7f9fc;
      padding: 40px 20px;
      color: #2c3e50;
      font-size: 1.1rem;
      display: flex;
      justify-content: center;
    }
    .container {
      height: auto;          /* Allow container height to grow with content */
      max-height: none; 
      max-width: 1400px;
      width: 100%;
      background: white;
      padding: 30px 40px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }
    h2 {
      margin-top: 0;
      margin-bottom: 30px;
      font-weight: 700;
      font-size: 2rem;
      text-align: center;
      color: #2c3e50;
    }

    /* Metadata block above each comparison */
    .object-metadata {
      display: flex;
      justify-content: flex-start;
      gap: 12px;
      margin-top: 30px;
      margin-bottom: 12px;
      font-weight: 700;
      font-size: 1.1rem;
      color: #0078d7;
      border-bottom: 2px solid #0078d7;
      padding-bottom: 6px;
      user-select: none;
      align-items: center; /* vertically center button and text */
    }
    .object-metadata > div {
      min-width: 150px;
    }

    /* Toggle button styling */
    .toggle-btn {
      cursor: pointer;
      font-size: 1.3rem;
      font-weight: 700;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      border: 2px solid #0078d7;
      background-color: white;
      color: #0078d7;
      user-select: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.3s ease, color 0.3s ease;
      padding: 0;
      line-height: 1;
    }
    .toggle-btn:hover {
      background-color: #0078d7;
      color: white;
    }

    /* Table styling */
    table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
      word-wrap: break-word;
      margin-bottom: 40px;
    }
    thead th {
      background-color: #0078d7;
      color: white;
      padding: 12px 8px;
      font-weight: 700;
      text-align: center;
      border-radius: 6px 6px 0 0;
      width: 50%;
    }
    tbody tr {
      border-bottom: 1.5px solid #ddd;
    }
    tbody tr:last-child {
      border-bottom: none;
    }
    td {
      padding: 10px 12px;
      vertical-align: top;
      width: 50%;
      overflow-wrap: break-word;
    }

    /* diff container styling */
    .diff-container {
      max-height: auto;
      overflow-y: auto;
      border: 1px solid #ccc;
      border-radius: 8px;
    }

    form {
      margin-top: 30px;
      text-align: center;
    }
    button {
      background-color: #0078d7;
      color: white;
      border: none;
      padding: 14px 48px;
      font-size: 1.3rem;
      font-weight: 600;
      border-radius: 50px;
      cursor: pointer;
      box-shadow: 0 6px 20px rgba(0,120,215,0.5);
      transition: background-color 0.3s ease, box-shadow 0.3s ease;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      min-width: 220px;
    }
    button:hover {
      background-color: #005ea1;
      box-shadow: 0 8px 26px rgba(0,94,161,0.7);
    }
    @media (max-width: 900px) {
      .object-metadata {
        flex-direction: column;
        gap: 6px;
      }
      .object-metadata > div {
        min-width: auto;
      }
      td {
        width: 100%;
      }
      .diff-container {
        max-height: auto;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Step 3: Compare Source and Destination JSONs</h2>

    {% for c in comparisons %}
      <div class="object-metadata" aria-label="Object metadata">
        <button class="toggle-btn" aria-expanded="true" aria-controls="content-{{ loop.index }}" aria-label="Toggle content for {{ c.objectName }}">−</button>
        <div>Object Type: <span>{{ c.objectType }}</span></div>
        <div>Object Name: <span>{{ c.objectName }}</span></div>
        <div>Comparison Result: <span>{{ c.diff }}</span></div>
      </div>

      <div id="content-{{ loop.index }}" class="collapsible-content" style="display: block;">
        <table aria-label="Source and Destination JSON Comparison for {{ c.objectName }}">
          <thead>
            <tr>
              <th>Source JSON</th>
              <th>Destination JSON</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td colspan="2">
                <!-- Diff will be rendered here -->
                <div id="diff-{{ loop.index }}" class="diff-container"></div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    {% endfor %}

    <form method="post" action="/step4_synapse" aria-label="Confirm migration form">
      <input type="hidden" name="sourceTenantId" value="{{ sourceTenantId }}">
      <input type="hidden" name="sourceClientId" value="{{ sourceClientId }}">
      <input type="hidden" name="sourceWorkspace" value="{{ sourceWorkspace }}">
      <input type="hidden" name="destTenantId" value="{{ destTenantId }}">
      <input type="hidden" name="SYNAPSE_TOKEN" value="{{ SYNAPSE_TOKEN }}">
      <input type="hidden" name="destWorkspace" value="{{ destWorkspace }}">
      <input type="hidden" name="sourceRepoName"     value ="{{ sourceRepoName }}">
      <input type="hidden" name="sourceFolderName" value ="{{ sourceFolderName }}">
      <input type="hidden" name="sourceBranch" value ="{{ sourceBranch }}">
      <input type="hidden" name="sourcePAT" value ="{{ sourcePAT }}">
      <input type="hidden" name="destRepoName" value ="{{ destRepoName }}">
      <input type="hidden" name="destFolderName"  value ="{{ destFolderName }}">
      <input type="hidden" name="destBranch" value ="{{ destBranch }}">
      <input type="hidden" name="destPAT" value ="{{ destPAT }}">
      <input type="hidden" name="crNumber" value="{{ crNumber }}">
      <input type="hidden" name="migration_plan_json" value="{{ migration_plan_json }}">
      <button type="submit">Confirm and Migrate</button>
    </form>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const comparisons = [
        {% for c in comparisons %}
        {
          sourceJson: {{ c.sourceJson | tojson }},
          destJson: {{ c.destJson | tojson }},
          objectType: {{ c.objectType | tojson }},
          objectName: {{ c.objectName | tojson }}
        },
        {% endfor %}
      ];

      comparisons.forEach((c, idx) => {
        const diffText = Diff.createTwoFilesPatch(
          `${c.objectType} Source`,
          `${c.objectType} Destination`,
          c.sourceJson,
          c.destJson,
          '',
          '',
          { context: 3 }
        );

        const diffHtml = Diff2Html.html(diffText, {
          drawFileList: true,
          matching: 'lines',
          outputFormat: 'side-by-side',
          synchronisedScroll: true,
          highlight: true
        });

        const diffContainer = document.getElementById(`diff-${idx + 1}`);
        if (diffContainer) {
          diffContainer.innerHTML = diffHtml;
        }
      });

      // Toggle button functionality
      document.querySelectorAll('.toggle-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const contentId = btn.getAttribute('aria-controls');
          const content = document.getElementById(contentId);
          if (!content) return;

          const isExpanded = btn.getAttribute('aria-expanded') === 'true';

          if (isExpanded) {
            content.style.display = 'none';
            btn.textContent = '+';
            btn.setAttribute('aria-expanded', 'false');
          } else {
            content.style.display = 'block';
            btn.textContent = '−'; // Unicode minus sign for better look
            btn.setAttribute('aria-expanded', 'true');
          }
        });
      });
    });
  </script>
</body>
</html>